/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package GUI.Views.gastos;

import GUI.Views.AbstractFragmentView;
import com.jidesoft.hints.ListDataIntelliHints;
import java.awt.Container;
import javax.swing.DefaultComboBoxModel;
import restManager.controller.Controller;
import restManager.controller.gasto.GastoOperacionController;
import restManager.exceptions.ValidatingException;
import restManager.persistencia.Gasto;
import restManager.persistencia.GastoVenta;
import restManager.printservice.Impresion;
import restManager.resources.R;
import restManager.resources.R.TipoGasto;
import restManager.util.RestManagerAbstractTableModel;
import restManager.util.utils;

/**
 *
 * @author Jorge
 */
public class GastoOperacionView extends AbstractFragmentView<Gasto> {

    ListDataIntelliHints<String> intellihints;
    GastoVenta editingGasto = null;

    public GastoOperacionView(Controller controller) {
        super(controller);
        initComponents();
    }

    public GastoOperacionView(Controller controller, Container parentComponent) {
        super(controller, parentComponent);
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanelInfo = new javax.swing.JPanel();
        jScrollPane4 = new javax.swing.JScrollPane();
        jTableInfo = new javax.swing.JTable();
        jButton1 = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jLabelGast = new javax.swing.JLabel();
        jButtonImprimirGastos = new javax.swing.JButton();
        jPanelAgregar = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jComboBoxCategoria = new javax.swing.JComboBox<>();
        jTextFieldTipo = new javax.swing.JTextField();
        jPanel5 = new javax.swing.JPanel();
        jSpinnerMonto = new javax.swing.JSpinner();
        jLabelMonto = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTextAreaDescripcion = new javax.swing.JTextArea();
        jButtonCrearE = new javax.swing.JButton();
        jButtonLimpiar = new javax.swing.JButton();

        setOpaque(false);
        setLayout(new java.awt.BorderLayout());

        jPanelInfo.setLayout(new java.awt.BorderLayout());

        jTableInfo.setAutoCreateRowSorter(true);
        jTableInfo.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Categoria", "Tipo", "Monto", "Descripcion"
            }
        ));
        jScrollPane4.setViewportView(jTableInfo);

        jPanelInfo.add(jScrollPane4, java.awt.BorderLayout.CENTER);

        java.util.ResourceBundle bundle = java.util.ResourceBundle.getBundle("Strings"); // NOI18N
        jButton1.setText(bundle.getString("label_eliminar")); // NOI18N
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jPanelInfo.add(jButton1, java.awt.BorderLayout.SOUTH);

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jLabelGast.setFont(new java.awt.Font("Lucida Grande", 1, 14)); // NOI18N
        jLabelGast.setForeground(new java.awt.Color(153, 0, 0));
        jLabelGast.setText("XXXX.XX CUC");
        jLabelGast.setBorder(javax.swing.BorderFactory.createTitledBorder(new javax.swing.border.LineBorder(new java.awt.Color(0, 0, 0), 3, true), "Total"));
        jPanel4.add(jLabelGast);

        jButtonImprimirGastos.setIcon(new javax.swing.ImageIcon(getClass().getResource("/restManager/resources/images/impresora.png"))); // NOI18N
        jButtonImprimirGastos.setHorizontalTextPosition(javax.swing.SwingConstants.LEFT);
        jButtonImprimirGastos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonImprimirGastosActionPerformed(evt);
            }
        });
        jPanel4.add(jButtonImprimirGastos);

        jPanelInfo.add(jPanel4, java.awt.BorderLayout.PAGE_START);

        add(jPanelInfo, java.awt.BorderLayout.CENTER);

        jPanelAgregar.setBorder(javax.swing.BorderFactory.createTitledBorder("Nuevo/Editar Gasto"));
        jPanelAgregar.setMaximumSize(new java.awt.Dimension(181, 2147483647));
        jPanelAgregar.setMinimumSize(new java.awt.Dimension(181, 85));
        jPanelAgregar.setPreferredSize(new java.awt.Dimension(182, 100));
        jPanelAgregar.setLayout(new java.awt.BorderLayout());

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.CENTER, 5, 15));

        jComboBoxCategoria.setBorder(javax.swing.BorderFactory.createTitledBorder("Categoría"));
        jComboBoxCategoria.setPreferredSize(new java.awt.Dimension(140, 51));
        jComboBoxCategoria.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jComboBoxCategoriaActionPerformed(evt);
            }
        });
        jPanel8.add(jComboBoxCategoria);

        jTextFieldTipo.setBorder(javax.swing.BorderFactory.createTitledBorder("Tipo"));
        jTextFieldTipo.setEnabled(false);
        jTextFieldTipo.setPreferredSize(new java.awt.Dimension(140, 40));
        jTextFieldTipo.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jTextFieldTipoMouseClicked(evt);
            }
        });
        jPanel8.add(jTextFieldTipo);

        jPanel5.setBorder(javax.swing.BorderFactory.createTitledBorder("Monto"));
        jPanel5.setMinimumSize(new java.awt.Dimension(150, 60));
        jPanel5.setPreferredSize(new java.awt.Dimension(145, 60));

        jSpinnerMonto.setModel(new javax.swing.SpinnerNumberModel(0.0f, 0.0f, null, 5.0f));
        jSpinnerMonto.setEnabled(false);
        jSpinnerMonto.setPreferredSize(new java.awt.Dimension(90, 26));
        jSpinnerMonto.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                jSpinnerMontoStateChanged(evt);
            }
        });
        jSpinnerMonto.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                jSpinnerMontoFocusGained(evt);
            }
        });
        jPanel5.add(jSpinnerMonto);

        jLabelMonto.setText("CUC");
        jPanel5.add(jLabelMonto);

        jPanel8.add(jPanel5);

        jScrollPane1.setBorder(javax.swing.BorderFactory.createTitledBorder("Descripción"));
        jScrollPane1.setHorizontalScrollBarPolicy(javax.swing.ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
        jScrollPane1.setVerticalScrollBarPolicy(javax.swing.ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER);
        jScrollPane1.setMaximumSize(new java.awt.Dimension(150, 32767));
        jScrollPane1.setMinimumSize(new java.awt.Dimension(140, 150));
        jScrollPane1.setPreferredSize(new java.awt.Dimension(140, 150));
        jScrollPane1.setSize(new java.awt.Dimension(140, 150));

        jTextAreaDescripcion.setColumns(5);
        jTextAreaDescripcion.setLineWrap(true);
        jTextAreaDescripcion.setRows(5);
        jTextAreaDescripcion.setTabSize(5);
        jTextAreaDescripcion.setEnabled(false);
        jTextAreaDescripcion.setMinimumSize(new java.awt.Dimension(140, 140));
        jTextAreaDescripcion.setPreferredSize(new java.awt.Dimension(240, 140));
        jTextAreaDescripcion.setSize(new java.awt.Dimension(240, 140));
        jScrollPane1.setViewportView(jTextAreaDescripcion);

        jPanel8.add(jScrollPane1);

        jPanelAgregar.add(jPanel8, java.awt.BorderLayout.CENTER);

        jButtonCrearE.setBackground(new java.awt.Color(204, 255, 255));
        jButtonCrearE.setText("Crear");
        jButtonCrearE.setEnabled(false);
        jButtonCrearE.setPreferredSize(new java.awt.Dimension(164, 28));
        jButtonCrearE.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonCrearEActionPerformed(evt);
            }
        });
        jPanelAgregar.add(jButtonCrearE, java.awt.BorderLayout.PAGE_END);

        jButtonLimpiar.setText(bundle.getString("label_limpiar")); // NOI18N
        jButtonLimpiar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonLimpiarActionPerformed(evt);
            }
        });
        jPanelAgregar.add(jButtonLimpiar, java.awt.BorderLayout.PAGE_START);

        add(jPanelAgregar, java.awt.BorderLayout.WEST);
    }// </editor-fold>//GEN-END:initComponents


    private void jComboBoxCategoriaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jComboBoxCategoriaActionPerformed
        if (jComboBoxCategoria.getSelectedIndex() != 0) {
            jTextFieldTipo.setEnabled(true);
            jSpinnerMonto.setEnabled(true);
            intellihints = new ListDataIntelliHints(jTextFieldTipo,
                    getController().getNombres(jComboBoxCategoria.getSelectedItem().toString()));
        } else {
            jTextFieldTipo.setEnabled(false);
        }
    }//GEN-LAST:event_jComboBoxCategoriaActionPerformed

    private void jTextFieldTipoMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jTextFieldTipoMouseClicked
        System.out.println("click");        // TODO add your handling code here:
    }//GEN-LAST:event_jTextFieldTipoMouseClicked

    private void jSpinnerMontoFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jSpinnerMontoFocusGained
        jSpinnerMonto.setValue(null);
    }//GEN-LAST:event_jSpinnerMontoFocusGained

    private void jButtonLimpiarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonLimpiarActionPerformed
        limpiarPanelCrear();        // TODO add your handling code here:
    }//GEN-LAST:event_jButtonLimpiarActionPerformed

    private void jButtonImprimirGastosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonImprimirGastosActionPerformed
        Impresion i = new Impresion();
         i.printResumenGastos(getController().getLista()); // TODO add your handling code here:
    }//GEN-LAST:event_jButtonImprimirGastosActionPerformed

    private void jButtonCrearEActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonCrearEActionPerformed
        crear();
    }//GEN-LAST:event_jButtonCrearEActionPerformed

    private void jSpinnerMontoStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_jSpinnerMontoStateChanged
        try {
            jButtonCrearE.setEnabled((float) jSpinnerMonto.getValue() > 0);
            jTextAreaDescripcion.setEnabled((float) jSpinnerMonto.getValue() > 0);
        } catch (ClassCastException e) {
            jButtonCrearE.setEnabled((int) jSpinnerMonto.getValue() > 0);
            jTextAreaDescripcion.setEnabled((int) jSpinnerMonto.getValue() > 0);
        }
    }//GEN-LAST:event_jSpinnerMontoStateChanged

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
    getController().removeGasto(((RestManagerAbstractTableModel<GastoVenta>)jTableInfo.getModel()).getObjectAtSelectedRow());        // TODO add your handling code here:
    }//GEN-LAST:event_jButton1ActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButtonCrearE;
    private javax.swing.JButton jButtonImprimirGastos;
    private javax.swing.JButton jButtonLimpiar;
    private javax.swing.JComboBox<TipoGasto> jComboBoxCategoria;
    private javax.swing.JLabel jLabelGast;
    private javax.swing.JLabel jLabelMonto;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanelAgregar;
    private javax.swing.JPanel jPanelInfo;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JSpinner jSpinnerMonto;
    private javax.swing.JTable jTableInfo;
    private javax.swing.JTextArea jTextAreaDescripcion;
    private javax.swing.JTextField jTextFieldTipo;
    // End of variables declaration//GEN-END:variables

    @Override
    public void updateView() {

        jTableInfo.setModel(new RestManagerAbstractTableModel<GastoVenta>(getController().getLista(), jTableInfo) {
            @Override
            public int getColumnCount() {
                return 4;
            }

            @Override
            public Object getValueAt(int rowIndex, int columnIndex) {
                switch (columnIndex) {
                    case 0:
                        return items.get(rowIndex).getGasto().getTipoGastoidGasto().getNombre();
                    case 1:
                        return items.get(rowIndex).getGasto().getNombre();
                    case 2:
                        return items.get(rowIndex).getImporte();
                    case 3:
                        return items.get(rowIndex).getDescripcion();
                    default:
                        return null;
                }
            }

            @Override
            public String getColumnName(int column) {
                switch (column) {
                    case 0:
                        return "Categoria";
                    case 1:
                        return "Tipo";
                    case 2:
                        return "Monto";
                    case 3:
                        return "Descripcion";
                    default:
                        return null;
                }
            }
        });

        jLabelGast.setText(utils.setDosLugaresDecimales(utils.calcularSumaTabla(jTableInfo, 2)));
        jComboBoxCategoria.setModel(new DefaultComboBoxModel<>(R.TipoGasto.values()));
        jLabelMonto.setText(R.COIN_SUFFIX);

    }

    @Override
    public GastoOperacionController getController() {
        return (GastoOperacionController) super.getController(); //To change body of generated methods, choose Tools | Templates.
    }

    private void limpiarPanelCrear() {
        jComboBoxCategoria.setSelectedIndex(0);

        jTextFieldTipo.setText("");
        jTextFieldTipo.setEnabled(false);

        jTextAreaDescripcion.setText("");
        jTextAreaDescripcion.setEnabled(false);

        jButtonCrearE.setEnabled(false);

        jSpinnerMonto.setValue(0);
        jSpinnerMonto.setEnabled(false);
    }

    private void crear() {
        if (validarDatos()) {
                getController().createNewGasto((R.TipoGasto) jComboBoxCategoria.getSelectedItem(),
                        jTextFieldTipo.getText(), (float) jSpinnerMonto.getValue(), jTextAreaDescripcion.getText());
            limpiarPanelCrear();
        } else {
            throw new ValidatingException(this);
        }
    }

  
    private boolean validarDatos() {
        return !(jComboBoxCategoria.getSelectedIndex() == 0 || jTextFieldTipo.getText().isEmpty());

    }

}
