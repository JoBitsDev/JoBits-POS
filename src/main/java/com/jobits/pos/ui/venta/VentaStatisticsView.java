/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.jobits.pos.ui.venta;

import com.jgoodies.binding.adapter.Bindings;
import com.jgoodies.binding.value.ValueModel;
import com.jobits.pos.ui.AbstractViewPanel;
import com.jobits.pos.ui.presenters.AbstractViewPresenter;
import com.jobits.pos.ui.venta.presenter.VentaCalendarViewModel;
import com.jhw.swing.material.standars.MaterialIcons;
import com.jobits.pos.ui.venta.presenter.VentaStatisticsViewModel;
import com.jobits.pos.ui.venta.presenter.VentaStatisticsViewPresenter;
import com.jobits.ui.components.MaterialComponentsFactory;
import com.jobits.ui.components.swing.displayers.Card;
import java.awt.Color;
import java.awt.Dimension;
import javax.swing.JPanel;
import org.knowm.xchart.XChartPanel;
import org.knowm.xchart.XYChart;
import org.knowm.xchart.XYChartBuilder;
import org.knowm.xchart.style.Styler;

/**
 *
 * @author Home
 */
public class VentaStatisticsView extends AbstractViewPanel {

    public static final String VIEW_NAME = "Estadisticas";

    public VentaStatisticsView(AbstractViewPresenter presenter) {
        super(presenter);
        updateDetallesGrafica();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane2 = new javax.swing.JScrollPane();
        jTree1 = new javax.swing.JTree();
        buttonGroupPeriodoChooser = new javax.swing.ButtonGroup();
        jPanelHeader = new javax.swing.JPanel();
        jPanelSeleccion = new javax.swing.JPanel();
        jPanelPeriodo = new javax.swing.JPanel();
        jButtonPeriodoSelector = new javax.swing.JButton();
        jPanel5 = new javax.swing.JPanel();
        jLabelPeriodoActual = new javax.swing.JLabel();
        jLabelPeriodoAnterior = new javax.swing.JLabel();
        jPanelPeriodChooser = new javax.swing.JPanel();
        jPanel7 = new javax.swing.JPanel();
        jDateChooserDel = new org.jdesktop.swingx.JXDatePicker();
        jPanel6 = new javax.swing.JPanel();
        jLabel14 = new javax.swing.JLabel();
        jDateChooserAl = new org.jdesktop.swingx.JXDatePicker();
        jPanel8 = new javax.swing.JPanel();
        jRadioButtonPeriodoAnterior = new javax.swing.JRadioButton();
        jRadioButtonAnnoAnterior = new javax.swing.JRadioButton();
        jPanelOpciones = new javax.swing.JPanel();
        jButtonRestablecer = MaterialComponentsFactory.Buttons.getMaterialButton();
        jPanelCardsStats = new javax.swing.JPanel();
        jPanelGrafica = new javax.swing.JPanel();
        jPanelTotalVenta = new javax.swing.JPanel();
        jPanelTotalGastos = new javax.swing.JPanel();
        jPanelTotalOrdenes = new javax.swing.JPanel();
        jPanelPorDesarrollar = new javax.swing.JPanel();

        jScrollPane2.setViewportView(jTree1);

        //buttonGroupPeriodoChooser.add(jRadioButtonPeriodoAnterior);
        //buttonGroupPeriodoChooser.add(jRadioButtonAnnoAnterior);

        setLayout(new java.awt.BorderLayout(5, 5));

        jPanelHeader.setLayout(new java.awt.BorderLayout());

        jPanelSeleccion.setBorder(new org.pushingpixels.lafwidget.utils.ShadowPopupBorder());
        jPanelSeleccion.setLayout(new java.awt.BorderLayout());

        jPanelPeriodo.setBorder(javax.swing.BorderFactory.createEmptyBorder(0, 10, 0, 0));
        jPanelPeriodo.setPreferredSize(new java.awt.Dimension(280, 50));
        jPanelPeriodo.setLayout(new java.awt.BorderLayout());

        jButtonPeriodoSelector.setIcon(MaterialIcons.ARROW_DROP_RIGHT);
        jButtonPeriodoSelector.setPreferredSize(new java.awt.Dimension(40, 32));
        jPanelPeriodo.add(jButtonPeriodoSelector, java.awt.BorderLayout.EAST);

        jPanel5.setBorder(javax.swing.BorderFactory.createEmptyBorder(5, 0, 0, 0));
        jPanel5.setPreferredSize(new java.awt.Dimension(200, 40));
        jPanel5.setLayout(new java.awt.GridLayout(2, 1));

        jLabelPeriodoActual.setFont(new java.awt.Font("Dialog", 0, 12)); // NOI18N
        jLabelPeriodoActual.setText("De :");
        jLabelPeriodoActual.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                jLabelPeriodoActualPropertyChange(evt);
            }
        });
        jPanel5.add(jLabelPeriodoActual);

        jLabelPeriodoAnterior.setFont(new java.awt.Font("Dialog", 0, 12)); // NOI18N
        jLabelPeriodoAnterior.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                jLabelPeriodoAnteriorPropertyChange(evt);
            }
        });
        jPanel5.add(jLabelPeriodoAnterior);

        jPanelPeriodo.add(jPanel5, java.awt.BorderLayout.CENTER);
        jPanel5.getAccessibleContext().setAccessibleName("SinglePeriod");

        jPanelSeleccion.add(jPanelPeriodo, java.awt.BorderLayout.WEST);

        jPanelPeriodChooser.setBorder(javax.swing.BorderFactory.createEmptyBorder(10, 5, 10, 0));
        jPanelPeriodChooser.setPreferredSize(new java.awt.Dimension(200, 50));
        jPanelPeriodChooser.setLayout(new java.awt.GridLayout(1, 3));

        jPanel7.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 10, 1, 10));
        jPanel7.setMinimumSize(new java.awt.Dimension(254, 20));
        jPanel7.setPreferredSize(new java.awt.Dimension(100, 20));
        jPanel7.setLayout(new java.awt.GridLayout(1, 0));

        jDateChooserDel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jDateChooserDelActionPerformed(evt);
            }
        });
        jPanel7.add(jDateChooserDel);

        jPanel6.setMinimumSize(new java.awt.Dimension(20, 26));
        jPanel6.setPreferredSize(new java.awt.Dimension(20, 100));

        jLabel14.setText("hasta");
        jLabel14.setToolTipText("");
        jLabel14.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jPanel6.add(jLabel14);

        jPanel7.add(jPanel6);

        jDateChooserAl.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jDateChooserAlActionPerformed(evt);
            }
        });
        jPanel7.add(jDateChooserAl);

        jPanelPeriodChooser.add(jPanel7);

        jPanel8.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 10, 1, 10));
        jPanel8.setLayout(new java.awt.GridLayout(1, 2));

        java.util.ResourceBundle bundle = java.util.ResourceBundle.getBundle("Strings"); // NOI18N
        jRadioButtonPeriodoAnterior.setText(bundle.getString("label_periodo_anterior")); // NOI18N
        jRadioButtonPeriodoAnterior.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jRadioButtonPeriodoAnterior.setHorizontalTextPosition(javax.swing.SwingConstants.RIGHT);
        jRadioButtonPeriodoAnterior.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonPeriodoAnteriorActionPerformed(evt);
            }
        });
        jPanel8.add(jRadioButtonPeriodoAnterior);

        jRadioButtonAnnoAnterior.setText(bundle.getString("label_anno_anterior")); // NOI18N
        jRadioButtonAnnoAnterior.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jRadioButtonAnnoAnterior.setHorizontalTextPosition(javax.swing.SwingConstants.RIGHT);
        jRadioButtonAnnoAnterior.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonAnnoAnteriorActionPerformed(evt);
            }
        });
        jPanel8.add(jRadioButtonAnnoAnterior);

        jPanelPeriodChooser.add(jPanel8);

        jPanelSeleccion.add(jPanelPeriodChooser, java.awt.BorderLayout.CENTER);

        jPanelOpciones.setMinimumSize(new java.awt.Dimension(100, 100));
        jPanelOpciones.setPreferredSize(new java.awt.Dimension(110, 50));
        jPanelOpciones.setLayout(new java.awt.GridLayout(1, 2, 5, 1));

        jButtonRestablecer.setText("Restablecer");
        jButtonRestablecer.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonRestablecerActionPerformed(evt);
            }
        });
        jPanelOpciones.add(jButtonRestablecer);

        jPanelSeleccion.add(jPanelOpciones, java.awt.BorderLayout.EAST);

        jPanelHeader.add(jPanelSeleccion, java.awt.BorderLayout.PAGE_START);

        jPanelCardsStats.setBorder(javax.swing.BorderFactory.createEmptyBorder(10, 10, 10, 10));
        jPanelCardsStats.setPreferredSize(new java.awt.Dimension(100, 130));
        jPanelCardsStats.setLayout(new java.awt.GridLayout(1, 6, 20, 0));
        jPanelHeader.add(jPanelCardsStats, java.awt.BorderLayout.CENTER);

        add(jPanelHeader, java.awt.BorderLayout.NORTH);

        jPanelGrafica.setLayout(new java.awt.GridLayout(2, 2));

        jPanelTotalVenta.setBorder(javax.swing.BorderFactory.createTitledBorder("Total Venta\n"));
        jPanelTotalVenta.setLayout(new java.awt.BorderLayout());
        jPanelGrafica.add(jPanelTotalVenta);

        jPanelTotalGastos.setBorder(javax.swing.BorderFactory.createTitledBorder("Total Gastos"));
        jPanelTotalGastos.setLayout(new java.awt.BorderLayout());
        jPanelGrafica.add(jPanelTotalGastos);

        jPanelTotalOrdenes.setBorder(javax.swing.BorderFactory.createTitledBorder("Total Ordenes"));
        jPanelTotalOrdenes.setLayout(new java.awt.BorderLayout());
        jPanelGrafica.add(jPanelTotalOrdenes);

        jPanelPorDesarrollar.setBorder(javax.swing.BorderFactory.createTitledBorder("POR DESARROLLAR"));
        jPanelPorDesarrollar.setLayout(new javax.swing.BoxLayout(jPanelPorDesarrollar, javax.swing.BoxLayout.LINE_AXIS));
        jPanelGrafica.add(jPanelPorDesarrollar);

        add(jPanelGrafica, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    private void jButtonRestablecerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonRestablecerActionPerformed
        buttonGroupPeriodoChooser.clearSelection();
        updateDetallesGrafica();
    }//GEN-LAST:event_jButtonRestablecerActionPerformed

    private void jRadioButtonPeriodoAnteriorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonPeriodoAnteriorActionPerformed
        updateDetallesGrafica();
    }//GEN-LAST:event_jRadioButtonPeriodoAnteriorActionPerformed

    private void jRadioButtonAnnoAnteriorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonAnnoAnteriorActionPerformed
        updateDetallesGrafica();
    }//GEN-LAST:event_jRadioButtonAnnoAnteriorActionPerformed

    private void jLabelPeriodoActualPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_jLabelPeriodoActualPropertyChange
    }//GEN-LAST:event_jLabelPeriodoActualPropertyChange

    private void jLabelPeriodoAnteriorPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_jLabelPeriodoAnteriorPropertyChange
    }//GEN-LAST:event_jLabelPeriodoAnteriorPropertyChange

    private void jDateChooserDelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jDateChooserDelActionPerformed
        updateDetallesGrafica();
    }//GEN-LAST:event_jDateChooserDelActionPerformed

    private void jDateChooserAlActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jDateChooserAlActionPerformed
        updateDetallesGrafica();
    }//GEN-LAST:event_jDateChooserAlActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroupPeriodoChooser;
    private javax.swing.JButton jButtonPeriodoSelector;
    private javax.swing.JButton jButtonRestablecer;
    private org.jdesktop.swingx.JXDatePicker jDateChooserAl;
    private org.jdesktop.swingx.JXDatePicker jDateChooserDel;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabelPeriodoActual;
    private javax.swing.JLabel jLabelPeriodoAnterior;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanelCardsStats;
    private javax.swing.JPanel jPanelGrafica;
    private javax.swing.JPanel jPanelHeader;
    private javax.swing.JPanel jPanelOpciones;
    private javax.swing.JPanel jPanelPeriodChooser;
    private javax.swing.JPanel jPanelPeriodo;
    private javax.swing.JPanel jPanelPorDesarrollar;
    private javax.swing.JPanel jPanelSeleccion;
    private javax.swing.JPanel jPanelTotalGastos;
    private javax.swing.JPanel jPanelTotalOrdenes;
    private javax.swing.JPanel jPanelTotalVenta;
    private javax.swing.JRadioButton jRadioButtonAnnoAnterior;
    private javax.swing.JRadioButton jRadioButtonPeriodoAnterior;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTree jTree1;
    // End of variables declaration//GEN-END:variables

    @Override
    public void wireUp() {
        Bindings.bind(jPanelPeriodChooser, "visible", getPresenter().getModel(VentaStatisticsViewModel.PROP_PANEL_OPCIONES_VISIBLE));
        Bindings.bind(jPanelOpciones, "visible", getPresenter().getModel(VentaStatisticsViewModel.PROP_PANEL_OPCIONES_VISIBLE));
        Bindings.bind(jDateChooserDel, "date", getPresenter().getModel(VentaCalendarViewModel.PROP_RESUMEN_DESDE));
        Bindings.bind(jDateChooserAl, "date", getPresenter().getModel(VentaCalendarViewModel.PROP_RESUMEN_HASTA));
        Bindings.bind(jLabelPeriodoActual, "text", getPresenter().getModel(VentaStatisticsViewModel.PROP_RANGO_FECHAS_TEXT));
        Bindings.bind(jLabelPeriodoAnterior, "text", getPresenter().getModel(VentaStatisticsViewModel.PROP_RANGO_FECHAS_ANTERIOR_TEXT));
        Bindings.bind(jRadioButtonPeriodoAnterior, getPresenter().getModel(VentaStatisticsViewModel.PROP_PERIODO_SELECTED));
        Bindings.bind(jRadioButtonAnnoAnterior, getPresenter().getModel(VentaStatisticsViewModel.PROP_ANNO_SELECTED));

        jRadioButtonPeriodoAnterior.addActionListener(getPresenter().getOperation(VentaStatisticsViewPresenter.ACTION_SET_PERIODO));
        jRadioButtonAnnoAnterior.addActionListener(getPresenter().getOperation(VentaStatisticsViewPresenter.ACTION_SET_ANNO));
        jButtonPeriodoSelector.addActionListener(getPresenter().getOperation(VentaStatisticsViewPresenter.ACTION_DESPLEGAR_OPCIONES));
        jButtonRestablecer.addActionListener(getPresenter().getOperation(VentaStatisticsViewPresenter.ACTION_RESTABLECER));

    }

    @Override
    public void uiInit() {
        initComponents();

        jPanelCardsStats.removeAll();
        Dimension dimension = new Dimension(20, 20);

        addCard(getPresenter().getModel(VentaStatisticsViewModel.PROP_TOTAL_VENTAS_INTERVALO_ACTUAL),
                getPresenter().getModel(VentaStatisticsViewModel.PROP_TOTAL_VENTAS_INTERVALO_ANTERIOR),
                "Total", dimension, jPanelCardsStats);
        addCard(getPresenter().getModel(VentaStatisticsViewModel.PROP_PROMEDIO_VENTAS_INTERVALO_ACTUAL),
                getPresenter().getModel(VentaStatisticsViewModel.PROP_PROMEDIO_VENTAS_INTERVALO_ANTERIOR),
                "Promedio", dimension, jPanelCardsStats);
        addCard(getPresenter().getModel(VentaStatisticsViewModel.PROP_HORA_PICO_INTERVALO_ACTUAL),
                getPresenter().getModel(VentaStatisticsViewModel.PROP_HORA_PICO_INTERVALO_ANTERIOR),
                "Hora Pico", dimension, jPanelCardsStats);
        addCard(getPresenter().getModel(VentaStatisticsViewModel.PROP_GASTO_INSUMO_INTERVALO_ACTUAL),
                getPresenter().getModel(VentaStatisticsViewModel.PROP_GASTO_INSUMO_INTERVALO_ANTERIOR),
                "Insumo", dimension, jPanelCardsStats);
        addCard(getPresenter().getModel(VentaStatisticsViewModel.PROP_GASTO_TRABAJADORES_INTERVALO_ACTUAL),
                getPresenter().getModel(VentaStatisticsViewModel.PROP_GASTO_TRABAJADORES_INTERVALO_ANTERIOR),
                "Trabajadores", dimension, jPanelCardsStats);
        addCard(getPresenter().getModel(VentaStatisticsViewModel.PROP_GASTO_OTROS_INTERVALO_ACTUAL),
                getPresenter().getModel(VentaStatisticsViewModel.PROP_GASTO_OTROS_INTERVALO_ANTERIOR),
                "Otros", dimension, jPanelCardsStats);
    }

    @Override
    public String getViewName() {
        return VIEW_NAME;
    }

    private Card addCard(ValueModel title, ValueModel subtitle, String supportText, Dimension dimension, JPanel panel) {
        Card c = MaterialComponentsFactory.Displayers.getLongCard(
                null,
                null,
                null,
                null,
                supportText,
                null,
                null,
                title,
                subtitle);
        c.setPreferredSize(dimension);
        c.setMaximumSize(dimension);
        c.setSecondaryTextColor(Color.red);
        panel.add(c);
        return c;
    }

    private void updateDetallesGrafica() {
        if (jPanelTotalVenta.getComponentCount() > 0) {
            jPanelTotalVenta.removeAll();
            jPanelTotalVenta.repaint();
        }
        if (jPanelTotalGastos.getComponentCount() > 0) {
            jPanelTotalGastos.removeAll();
            jPanelTotalGastos.repaint();
        }
        if (jPanelTotalOrdenes.getComponentCount() > 0) {
            jPanelTotalOrdenes.removeAll();
            jPanelTotalOrdenes.repaint();
        }
        if (jPanelPorDesarrollar.getComponentCount() > 0) {
            jPanelPorDesarrollar.removeAll();
            jPanelPorDesarrollar.repaint();
        }
        String actual = "Periodo actual", anterior = "Periodo anterior";
        XChartPanel wrapper;

        //*GRAFICA TOTAL VENTAS*//
        XYChart chart = setChartStyle();
        chart.addSeries(actual, VentaStatisticsViewModel.getLista_dias_actual(), VentaStatisticsViewModel.getLista_total_actual());
        if ((jRadioButtonPeriodoAnterior.isSelected()) || (jRadioButtonAnnoAnterior.isSelected())) {
            chart.addSeries(anterior, VentaStatisticsViewModel.getLista_dias_anterior(), VentaStatisticsViewModel.getLista_total_anterior());
        }
        wrapper = new XChartPanel(chart);

        jPanelTotalVenta.add(wrapper);

        //*GRAFICA TOTAL GASTOS*//
        chart = setChartStyle();
        chart.addSeries(actual, VentaStatisticsViewModel.getLista_dias_actual(), VentaStatisticsViewModel.getLista_gastos_actual());
        if ((jRadioButtonPeriodoAnterior.isSelected()) || (jRadioButtonAnnoAnterior.isSelected())) {
            chart.addSeries(anterior, VentaStatisticsViewModel.getLista_dias_anterior(), VentaStatisticsViewModel.getList_gastos_anterior());
        }
        wrapper = new XChartPanel(chart);

        jPanelTotalGastos.add(wrapper);

        //*GRAFICA TOTAL ORDENES*//
        chart = setChartStyle();
        chart.setYAxisTitle("Ordenes");
        chart.addSeries(actual, VentaStatisticsViewModel.getLista_dias_actual(), VentaStatisticsViewModel.getList_ordenes_actual());
        if ((jRadioButtonPeriodoAnterior.isSelected()) || (jRadioButtonAnnoAnterior.isSelected())) {
            chart.addSeries(anterior, VentaStatisticsViewModel.getLista_dias_anterior(), VentaStatisticsViewModel.getLista_ordenes_anterior());
        }
        wrapper = new XChartPanel(chart);

        jPanelTotalOrdenes.add(wrapper);

    }

    private XYChart setChartStyle() {
        XYChart chart = new XYChartBuilder().xAxisTitle("Dias").yAxisTitle("Monto").build();
        chart.getStyler().setDatePattern("dd'/'MM'/'yy");
        chart.getStyler().setPlotGridLinesVisible(true);
        chart.getStyler().setLegendLayout(Styler.LegendLayout.Horizontal);
        chart.getStyler().setLegendPosition(Styler.LegendPosition.OutsideS);
        Color[] seriesColors = {Color.BLACK, Color.RED};
        chart.getStyler().setSeriesColors(seriesColors);
        return chart;
    }
}
