/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.jobits.pos.ui.trabajadores;

import com.jgoodies.binding.adapter.Bindings;
import com.jgoodies.binding.list.SelectionInList;
import com.root101.swing.material.standards.MaterialIcons;
import java.util.ArrayList;
import java.util.List;
import org.knowm.xchart.PieChart;
import org.knowm.xchart.PieChartBuilder;
import org.knowm.xchart.XChartPanel;
import org.knowm.xchart.XYChart;
import org.knowm.xchart.XYChartBuilder;
import org.knowm.xchart.XYSeries;
import org.knowm.xchart.style.PieStyler;
import org.knowm.xchart.style.Styler;
import com.jobits.pos.core.domain.AsistenciaPersonalEstadisticas;
import com.jobits.pos.recursos.R;
import com.jobits.pos.ui.AbstractViewPanel;
import com.jobits.pos.ui.DefaultValues;
import com.jobits.pos.ui.presenters.AbstractViewPresenter;
import com.jobits.pos.ui.trabajadores.presenter.NominasDetailPresenter;
import com.jobits.pos.ui.swing.utils.BindableTableModel;
import com.jobits.pos.utils.utils;
import com.jobits.ui.components.MaterialComponentsFactory;
import static com.jobits.pos.ui.trabajadores.presenter.NominasDetailViewModel.*;
import java.awt.BorderLayout;
import javax.swing.ListModel;
import javax.swing.event.ChangeEvent;
import javax.swing.event.TableModelEvent;

/**
 *
 * @author Jorge
 */
//TODO: cuando cambias de redio button no actualiza
//TODO: paneles de colores distintos
//
public class NominasDetailView extends AbstractViewPanel {

    BindableTableModel<AsistenciaPersonalEstadisticas> model;

    public static final String VIEW_NAME = "Nominas";

    public NominasDetailView(AbstractViewPresenter presenter) {
        super(presenter);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanelSeleccion = MaterialComponentsFactory.Containers.getPrimaryPanel();
        jPanelPeriodo = MaterialComponentsFactory.Containers.getTransparentPanel();
        jButtonPeriodoSelector = MaterialComponentsFactory.Buttons.getOutlinedButton();
        jPanel5 = MaterialComponentsFactory.Containers.getTransparentPanel();
        jLabelPeriodoActual = new javax.swing.JLabel();
        jPanelPeriodChooser = MaterialComponentsFactory.Containers.getTransparentPanel();
        jPanel7 = MaterialComponentsFactory.Containers.getTransparentPanel();
        jDateChooserDel = MaterialComponentsFactory.Input.getUnlabeledDatePicker();
        jPanel6 = MaterialComponentsFactory.Containers.getTransparentPanel();
        jLabel14 = new javax.swing.JLabel();
        jDateChooserAl = MaterialComponentsFactory.Input.getUnlabeledDatePicker();
        jPanel8 = MaterialComponentsFactory.Containers.getTransparentPanel();
        jRadioButtonXY = new javax.swing.JRadioButton();
        jRadioButtonPie = new javax.swing.JRadioButton();
        jPanelData = MaterialComponentsFactory.Containers.getTransparentPanel();
        jPanelIzq = MaterialComponentsFactory.Containers.getSecondaryPanel();
        jCheckBoxseleccionarTodos = new javax.swing.JCheckBox();
        jScrollPane2 = MaterialComponentsFactory.Containers.getScrollPane();
        jTableUsuariosActivos = new javax.swing.JTable();
        jLabelAcumulado = MaterialComponentsFactory.Displayers.getLabel();
        jPanelGrafica = MaterialComponentsFactory.Containers.getTransparentPanel();
        jPanelBotones = MaterialComponentsFactory.Containers.getPrimaryPanel();
        jButtonAcumulado = MaterialComponentsFactory.Buttons.getLinedButton();
        jButtonPagar = MaterialComponentsFactory.Buttons.getMaterialButton();

        setBorder(javax.swing.BorderFactory.createEmptyBorder(5, 5, 5, 5));
        setOpaque(false);
        setLayout(new java.awt.BorderLayout(5, 5));

        jPanelSeleccion.setBorder(javax.swing.BorderFactory.createEmptyBorder(0, 15, 0, 15));
        jPanelSeleccion.setLayout(new java.awt.BorderLayout());

        jPanelPeriodo.setBorder(javax.swing.BorderFactory.createEmptyBorder(0, 10, 0, 0));
        jPanelPeriodo.setPreferredSize(new java.awt.Dimension(325, 50));
        jPanelPeriodo.setLayout(new java.awt.BorderLayout());

        jButtonPeriodoSelector.setIcon(MaterialIcons.ARROW_DROP_RIGHT);
        jButtonPeriodoSelector.setPreferredSize(new java.awt.Dimension(40, 32));
        jPanelPeriodo.add(jButtonPeriodoSelector, java.awt.BorderLayout.EAST);

        jPanel5.setBorder(javax.swing.BorderFactory.createEmptyBorder(5, 0, 0, 0));
        jPanel5.setPreferredSize(new java.awt.Dimension(200, 40));
        jPanel5.setLayout(new java.awt.BorderLayout());

        jLabelPeriodoActual.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        jLabelPeriodoActual.setText("De :");
        jLabelPeriodoActual.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                jLabelPeriodoActualPropertyChange(evt);
            }
        });
        jPanel5.add(jLabelPeriodoActual, java.awt.BorderLayout.CENTER);

        jPanelPeriodo.add(jPanel5, java.awt.BorderLayout.CENTER);

        jPanelSeleccion.add(jPanelPeriodo, java.awt.BorderLayout.WEST);

        jPanelPeriodChooser.setBorder(javax.swing.BorderFactory.createEmptyBorder(10, 5, 10, 0));
        jPanelPeriodChooser.setPreferredSize(new java.awt.Dimension(200, 50));
        jPanelPeriodChooser.setLayout(new java.awt.GridLayout(1, 3));

        jPanel7.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 10, 1, 10));
        jPanel7.setMinimumSize(new java.awt.Dimension(254, 20));
        jPanel7.setPreferredSize(new java.awt.Dimension(100, 20));
        jPanel7.setLayout(new java.awt.GridLayout(1, 0));

        jDateChooserDel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jDateChooserDelActionPerformed(evt);
            }
        });
        jPanel7.add(jDateChooserDel);

        jPanel6.setMinimumSize(new java.awt.Dimension(20, 26));
        jPanel6.setPreferredSize(new java.awt.Dimension(20, 100));

        jLabel14.setText("hasta");
        jLabel14.setToolTipText("");
        jLabel14.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jPanel6.add(jLabel14);

        jPanel7.add(jPanel6);

        jDateChooserAl.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jDateChooserAlActionPerformed(evt);
            }
        });
        jPanel7.add(jDateChooserAl);

        jPanelPeriodChooser.add(jPanel7);

        jPanel8.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 10, 1, 10));
        jPanel8.setLayout(new java.awt.GridLayout(1, 2));

        jRadioButtonXY.setText("Dias Trabajados");
        jRadioButtonXY.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jRadioButtonXY.setHorizontalTextPosition(javax.swing.SwingConstants.RIGHT);
        jRadioButtonXY.setOpaque(false);
        jRadioButtonXY.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonXYActionPerformed(evt);
            }
        });
        jPanel8.add(jRadioButtonXY);

        jRadioButtonPie.setText("Ventas Generales");
        jRadioButtonPie.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jRadioButtonPie.setHorizontalTextPosition(javax.swing.SwingConstants.RIGHT);
        jRadioButtonPie.setOpaque(false);
        jRadioButtonPie.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonPieActionPerformed(evt);
            }
        });
        jPanel8.add(jRadioButtonPie);

        jPanelPeriodChooser.add(jPanel8);

        jPanelSeleccion.add(jPanelPeriodChooser, java.awt.BorderLayout.CENTER);

        add(jPanelSeleccion, java.awt.BorderLayout.PAGE_START);

        jPanelData.setLayout(new java.awt.BorderLayout());

        jPanelIzq.setBorder(javax.swing.BorderFactory.createEmptyBorder(15, 15, 15, 15));
        jPanelIzq.setMaximumSize(new java.awt.Dimension(2147483647, 100));
        jPanelIzq.setMinimumSize(new java.awt.Dimension(375, 510));
        jPanelIzq.setPreferredSize(new java.awt.Dimension(325, 510));
        jPanelIzq.setLayout(new java.awt.BorderLayout(5, 5));

        jCheckBoxseleccionarTodos.setText("Seleccionar Todos");
        jCheckBoxseleccionarTodos.setHorizontalAlignment(javax.swing.SwingConstants.TRAILING);
        jCheckBoxseleccionarTodos.setHorizontalTextPosition(javax.swing.SwingConstants.LEFT);
        jPanelIzq.add(jCheckBoxseleccionarTodos, java.awt.BorderLayout.PAGE_START);

        jScrollPane2.setOpaque(false);

        jTableUsuariosActivos.setAutoCreateRowSorter(true);
        jTableUsuariosActivos.setFont(new java.awt.Font("Lucida Grande", 0, 18)); // NOI18N
        jTableUsuariosActivos.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Usuario", "Dias", "Promedio", ""
            }
        ) {
            boolean[] canEdit = new boolean [] {
                true, false, true, true
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(jTableUsuariosActivos);
        if (jTableUsuariosActivos.getColumnModel().getColumnCount() > 0) {
            jTableUsuariosActivos.getColumnModel().getColumn(0).setMinWidth(100);
            jTableUsuariosActivos.getColumnModel().getColumn(0).setPreferredWidth(100);
            jTableUsuariosActivos.getColumnModel().getColumn(0).setMaxWidth(150);
            jTableUsuariosActivos.getColumnModel().getColumn(1).setMinWidth(50);
            jTableUsuariosActivos.getColumnModel().getColumn(1).setPreferredWidth(50);
            jTableUsuariosActivos.getColumnModel().getColumn(1).setMaxWidth(80);
            jTableUsuariosActivos.getColumnModel().getColumn(2).setMinWidth(100);
            jTableUsuariosActivos.getColumnModel().getColumn(2).setPreferredWidth(100);
            jTableUsuariosActivos.getColumnModel().getColumn(2).setMaxWidth(150);
            jTableUsuariosActivos.getColumnModel().getColumn(3).setMinWidth(30);
            jTableUsuariosActivos.getColumnModel().getColumn(3).setPreferredWidth(30);
            jTableUsuariosActivos.getColumnModel().getColumn(3).setMaxWidth(50);
        }

        jPanelIzq.add(jScrollPane2, java.awt.BorderLayout.CENTER);

        jLabelAcumulado.setFont(new java.awt.Font("Lucida Grande", 1, 18)); // NOI18N
        jLabelAcumulado.setHorizontalAlignment(javax.swing.SwingConstants.TRAILING);
        jLabelAcumulado.setText("           --               ");
        jLabelAcumulado.setBorder(javax.swing.BorderFactory.createCompoundBorder(null, javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createEmptyBorder(1, 1, 1, 1), "Total", javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font("Lucida Grande", 0, 18)))); // NOI18N
        jLabelAcumulado.setMaximumSize(new java.awt.Dimension(300, 50));
        jLabelAcumulado.setOpaque(true);
        jPanelIzq.add(jLabelAcumulado, java.awt.BorderLayout.PAGE_END);

        jPanelData.add(jPanelIzq, java.awt.BorderLayout.WEST);

        jPanelGrafica.setLayout(new java.awt.BorderLayout());
        jPanelData.add(jPanelGrafica, java.awt.BorderLayout.CENTER);

        add(jPanelData, java.awt.BorderLayout.CENTER);

        jPanelBotones.setPreferredSize(new java.awt.Dimension(300, 60));
        jPanelBotones.setLayout(new java.awt.GridBagLayout());

        jButtonAcumulado.setIcon(new javax.swing.ImageIcon(getClass().getResource("/restManager/resources/icons pack/imprimir_detallado_indigo.png"))); // NOI18N
        jButtonAcumulado.setText("Imprimir");
        jButtonAcumulado.setPreferredSize(new java.awt.Dimension(130, 50));
        jPanelBotones.add(jButtonAcumulado, new java.awt.GridBagConstraints());

        jButtonPagar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/restManager/resources/icons pack/billete_gris.png"))); // NOI18N
        jButtonPagar.setText("Pagar");
        jButtonPagar.setPreferredSize(new java.awt.Dimension(130, 50));
        jPanelBotones.add(jButtonPagar, new java.awt.GridBagConstraints());

        add(jPanelBotones, java.awt.BorderLayout.SOUTH);
    }// </editor-fold>//GEN-END:initComponents

    private void jLabelPeriodoActualPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_jLabelPeriodoActualPropertyChange

    }//GEN-LAST:event_jLabelPeriodoActualPropertyChange

    private void jDateChooserDelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jDateChooserDelActionPerformed
        getPresenter().getOperation(NominasDetailPresenter.ACTION_BUSCAR).doAction();
    }//GEN-LAST:event_jDateChooserDelActionPerformed

    private void jDateChooserAlActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jDateChooserAlActionPerformed
        getPresenter().getOperation(NominasDetailPresenter.ACTION_BUSCAR).doAction();
    }//GEN-LAST:event_jDateChooserAlActionPerformed

    private void jRadioButtonXYActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonXYActionPerformed
    }//GEN-LAST:event_jRadioButtonXYActionPerformed

    private void jRadioButtonPieActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonPieActionPerformed
    }//GEN-LAST:event_jRadioButtonPieActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JButton jButtonAcumulado;
    private javax.swing.JButton jButtonPagar;
    private javax.swing.JButton jButtonPeriodoSelector;
    private javax.swing.JCheckBox jCheckBoxseleccionarTodos;
    private org.jdesktop.swingx.JXDatePicker jDateChooserAl;
    private org.jdesktop.swingx.JXDatePicker jDateChooserDel;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabelAcumulado;
    private javax.swing.JLabel jLabelPeriodoActual;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanelBotones;
    private javax.swing.JPanel jPanelData;
    private javax.swing.JPanel jPanelGrafica;
    private javax.swing.JPanel jPanelIzq;
    private javax.swing.JPanel jPanelPeriodChooser;
    private javax.swing.JPanel jPanelPeriodo;
    private javax.swing.JPanel jPanelSeleccion;
    private javax.swing.JRadioButton jRadioButtonPie;
    private javax.swing.JRadioButton jRadioButtonXY;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTable jTableUsuariosActivos;
    // End of variables declaration//GEN-END:variables

    private void updateDetallesPanel(List<AsistenciaPersonalEstadisticas> displayList, Choice choice) {
        if (jPanelGrafica.getComponentCount() > 0) {
            jPanelGrafica.removeAll();
        }
        XYChart chart = new XYChartBuilder().xAxisTitle("Dias").yAxisTitle("Monto").build();
        PieChart chartPie = new PieChartBuilder().theme(Styler.ChartTheme.XChart).build();

        chart.getStyler().setDatePattern("dd-MMM");
        chart.getStyler().setPlotGridLinesVisible(false);

        chart.getStyler().setCursorEnabled(true);

        chartPie.getStyler().setAnnotationType(PieStyler.AnnotationType.Percentage);

        float acumulado = 0, propina = 0;

        for (AsistenciaPersonalEstadisticas a : displayList) {
            String label = a.getP().getUsuario() + "(" + a.getCantidadDiasTrabajados() + " Dias) ( " + utils.setDosLugaresDecimales(a.getTotalPago()) + ")";
            XYSeries serie = chart.addSeries(label, a.getDiasTrabajados(), a.getMontos());
            chartPie.addSeries(label, a.getTotalPago());
            acumulado += a.getTotalPago();
            propina += a.getTotalPropina();

        }

        XChartPanel wrapper = new XChartPanel(chart),
                wrapperPie = new XChartPanel(chartPie);

        switch (choice) {
            case PIE:
                jPanelGrafica.add(wrapperPie, BorderLayout.CENTER);
                break;
            case XY:
                jPanelGrafica.add(wrapper, BorderLayout.CENTER);
                break;
            default:
                break;

        }
        jLabelAcumulado.setText(utils.setDosLugaresDecimales(acumulado));
    }

    @Override
    public String getViewName() {
        return VIEW_NAME;
    }

    @Override
    public void wireUp() {
        Bindings.bind(jPanelPeriodChooser, "visible", getPresenter().getModel(PROP_PANEL_OPCIONES_VISIBLE));

        jButtonPeriodoSelector.addActionListener(getPresenter().getOperation(NominasDetailPresenter.ACTION_DESPLEGAR_OPCIONES));
        Bindings.bind(jLabelPeriodoActual, "text", getPresenter().getModel(PROP_RANGO_FECHAS_TEXT));

        Bindings.bind(jTableUsuariosActivos, new SelectionInList(
                getPresenter().getModel(PROP_LISTA_PERSONAL),
                getPresenter().getModel(PROP_PERSONAL_SELECCIONADO)));
        jButtonPagar.addActionListener(getPresenter().getOperation(NominasDetailPresenter.ACTION_PAGAR));
        jButtonAcumulado.addActionListener(getPresenter().getOperation(NominasDetailPresenter.ACTION_IMPRIMIR));
        jCheckBoxseleccionarTodos.setAction(getPresenter().getOperation(NominasDetailPresenter.ACTION_SELECCIONAR_TODOS));
        Bindings.bind(jCheckBoxseleccionarTodos, getPresenter().getModel(PROP_SELECCIONAR_TODO_SELECCIONADO));
        Bindings.bind(jDateChooserDel, "date", getPresenter().getModel(PROP_FECHA_DESDE));
        Bindings.bind(jDateChooserAl, "date", getPresenter().getModel(PROP_FECHA_HASTA));
    }

    @Override
    public void uiInit() {
        initComponents();
        model = new BindableTableModel<AsistenciaPersonalEstadisticas>(jTableUsuariosActivos) {
            @Override
            public int getColumnCount() {
                return 4;
            }

            @Override
            public Object getValueAt(int rowIndex, int columnIndex) {
                switch (columnIndex) {
                    case 0:
                        return getRow(rowIndex).getP().getUsuario();
                    case 1:
                        return getRow(rowIndex).getCantidadDiasTrabajados();
                    case 2:
                        return utils.setDosLugaresDecimalesFloat(getRow(rowIndex).getPromedioCobro());
                    case 3:
                        return getRow(rowIndex).isUse();
                    default:
                        return null;
                }
            }

            @Override
            public String getColumnName(int column) {
                switch (column) {
                    case 0:
                        return "Usuario";
                    case 1:
                        return "Días";
                    case 2:
                        return "Promedio (" + R.COIN_SUFFIX + ")";
                    case 3:
                        return "";
                    default:
                        return null;

                }
            }

            @Override
            public Class<?> getColumnClass(int columnIndex) {
                return columnIndex == 3 ? Boolean.class : super.getColumnClass(columnIndex);
            }

            @Override
            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return columnIndex == 3;
            }

            @Override
            public void setValueAt(Object aValue, int rowIndex, int columnIndex) {
                getRow(rowIndex).setUse((boolean) aValue);
                fireTableRowsUpdated(rowIndex, rowIndex);
            }
        };
        jTableUsuariosActivos.setModel(model);
        jTableUsuariosActivos.getColumnModel().getColumn(3).setWidth(30);
        jTableUsuariosActivos.getColumnModel().getColumn(1).setCellRenderer(utils.numberColumCellRender());
        jTableUsuariosActivos.getColumnModel().getColumn(2).setCellRenderer(utils.numberColumCellRender());
        jTableUsuariosActivos.getModel().addTableModelListener((TableModelEvent e) -> {
            if (e.getType() == TableModelEvent.UPDATE) {
                onDetallesClick();
            }
        });
        buttonGroup1.add(jRadioButtonPie);
        buttonGroup1.add(jRadioButtonXY);
        jRadioButtonPie.addChangeListener((ChangeEvent e) -> {
            onDetallesClick();
        });
        jRadioButtonXY.addChangeListener((ChangeEvent e) -> {
            onDetallesClick();
        });
        jRadioButtonXY.setSelected(true);

    }

    private enum Choice {
        PIE, XY, RAW
    }

    void onDetallesClick() {
        if (jTableUsuariosActivos.getModel().getRowCount() > 0) {
            List<AsistenciaPersonalEstadisticas> use = new ArrayList<>();
            ListModel<AsistenciaPersonalEstadisticas> aux = ((BindableTableModel<AsistenciaPersonalEstadisticas>) jTableUsuariosActivos.getModel()).getListModel();
            for (int i = 0; i < aux.getSize(); i++) {
                if (aux.getElementAt(i).isUse()) {
                    use.add(aux.getElementAt(i));
                }
            }

            Choice choice = Choice.XY;
            if (jRadioButtonPie.isSelected()) {
                choice = Choice.PIE;
            }

            updateDetallesPanel(use, choice);
        }
        jPanelGrafica.revalidate();

    }

}
